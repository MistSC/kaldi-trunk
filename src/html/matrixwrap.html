<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<title>Kaldi: External matrix libraries</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link rel="icon" href="favicon.ico" type="image/x-icon" />
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
  $(window).load(resizeHeight);
</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { searchBox.OnSelectItem(0); });
</script>
<link href="stylesheet.css" rel="stylesheet" type="text/css" /> 
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
 <td id="projectlogo"><a href="http://kaldi-asr.org/"><img alt="Logo" src="KaldiTextAndLogoSmall.png"/ style="padding: 3px 5px 1px 5px"></a></td>
  <td style="padding-left: 0.5em;">
   <div id="projectname" style="display:none">Kaldi
   </div>
  </td>
    <td style="padding-left: 0.5em;">
    <div id="projectbrief" style="display:none"></div>
    </td>
   <!--END PROJECT_BRIEF-->
  <!--END !PROJECT_NAME-->
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.6 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li class="current"><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li><a href="files.html"><span>Files</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('matrixwrap.html','');});
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Classes</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Namespaces</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Files</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&#160;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&#160;</span>Typedefs</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(7)"><span class="SelectionMark">&#160;</span>Enumerations</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(8)"><span class="SelectionMark">&#160;</span>Enumerator</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(9)"><span class="SelectionMark">&#160;</span>Friends</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(10)"><span class="SelectionMark">&#160;</span>Macros</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(11)"><span class="SelectionMark">&#160;</span>Groups</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(12)"><span class="SelectionMark">&#160;</span>Pages</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">External matrix libraries </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>Here we describe how our <a class="el" href="matrix.html">matrix library</a> makes use of external libraries.</p>
<h1><a class="anchor" id="matrixwrap_summary"></a>
Overview</h1>
<p>The matrix code in Kaldi is mostly a wrapper on top of the linear-algebra libraries BLAS and LAPACK. The code has been designed to be as flexible as possible in terms of what libraries it can use. Currently it supports four options:</p>
<ul>
<li>ATLAS, which is an implementation of BLAS plus a subset of LAPACK (with a different interface)</li>
<li>Some implementation of BLAS plus CLAPACK (note: this has not been tested recently).</li>
<li>Intel's MKL, which provides both BLAS and LAPACK</li>
<li>OpenBLAS, which provides BLAS and LAPACK</li>
</ul>
<p>The code has to "know" which of these four options is being used, because although in principle BLAS and LAPACK are standardized, there are some differences in the interfaces. The Kaldi code requires exactly one of the three strings HAVE_ATLAS, HAVE_CLAPACK, HAVE_OPENBLAS or HAVE_MKL to be defined (e.g. using -DHAVE_ATLAS as an option to the compiler). It must then be linked with the appropriate libraries. The code that deals most directly with including the external libraries and setting up the appropriate typedef's and defines, is in <a class="el" href="kaldi-blas_8h.html">kaldi-blas.h</a>. However, the rest of the matrix code is not completely insulated from these issues because the ATLAS and CLAPACK versions of higher-level routines are called differently (so we have a lot of "#ifdef HAVE_ATLAS" directives and the like). Additionally, some routines are not even available in ATLAS so we have had to implement them ourselves.</p>
<p>The "configure" script in the "src" directory is responsible for setting up Kaldi to use the libraries. It does this by creating the file "kaldi.mk" in the "src" directory, which gives appropriate flags to the compiler. If called with no arguments it will use any ATLAS installation it can find in "normal" places in your system, but it is quite configurable. See the script itself for usage.</p>
<h1><a class="anchor" id="matrixwrap_blas"></a>
Basic Linear Algebra Subroutines (BLAS)</h1>
<p>Because we refer a lot to BLAS in this section, we briefly explain what it is. BLAS is a set of subroutine declarations that correspond to low-level matrix-vector operations. There is Level 1 Blas (vector-vector), Level 2 (vector-matrix) and Level 3 (matrix-matrix). They have names like daxpy (for double-precision a*x plus y), and dgemm (for double general matrix-matrix multiply). BLAS has various actual implementations. The "reference BLAS", supplied I believe by Netlib (the folks who also brought us the most common version of LAPACK), is one. ATLAS is another one (but it also implements some functions from LAPACK).</p>
<h1><a class="anchor" id="matrixwrap_lapack"></a>
Linear Algebra PACKage (LAPACK)</h1>
<p>Lapack is a set of linear-algebra routines, originally written in Fortran. It includes higher-level routines than BLAS, such as matrix inversion, SVD, etc. Netlib has implemented this (this is the "normal" LAPACK). LAPACK requires BLAS. It is possible to mix-and-match LAPACK and BLAS implementations (e.g. Netlib's LAPACK with ATLAS's BLAS).</p>
<p>CLAPACK is a version of LAPACK that has been converted from Fortan to C automatically using the f2c utility. When we talk about using LAPACK, we are actually talking about using CLAPACK. Because CLAPACK has been converted to C using the f2c utility, when we link against it we need to include the f2c library (e.g. -lf2c, or -lg2c if using recent versions of gcc), otherwise we will get linking errors.</p>
<h1><a class="anchor" id="matrixwrap_atlas"></a>
Automatically Tuned Linear Algebra Software (ATLAS)</h1>
<p>ATLAS is a well known implementation of BLAS plus a subset of LAPACK. The general idea of ATLAS is to tune to the particular processor setup, so the compilation process is quite complex and can take a while. For this reason, it can be quite tricky to compile ATLAS. On UNIX-based systems, you can't even do it unless you are root or are friendly with your system administrator, because to compile it you need to turn off CPU throttling; and on Windows, ATLAS does not compile "natively", only in Cygwin. Sometimes it can be a better bet to find libraries that have been compiled by someone else for your particular platform, but we can't offer much advice on how to do this. ATLAS generally performs better than the "reference BLAS" available from Netlib. ATLAS only includes a few LAPACK routines. These include matrix inversion and Cholesky factorization, but not SVD. For this reason we have implemented a couple more of the LAPACK routines (SVD and eigenvalue decomposition); see the next section.</p>
<p>ATLAS conforms to the BLAS interface, but its interface for the subset of LAPACK routines that it provides is not the same as Netlib's (it's more C-like and less FORTRAN-ish). For this reason, there are quite a number of #ifdef's in our code to switch between the calling styles, depending whether we are linking with ATLAS or CLAPACK.</p>
<h2><a class="anchor" id="matrixwrap_atlas_install_windows"></a>
Installing ATLAS (on Windows)</h2>
<p>For instructions on how to install ATLAS on Windows (and note that these instructions require Cygwin), see the file windows/INSTALL.atlas in our source distribution. Note that our Windows setup is not being actvely maintained at the moment and we don't anticipate that it will work very cleanly.</p>
<h2><a class="anchor" id="matrixwrap_atlas_install_linux"></a>
Installing ATLAS (on Linux)</h2>
<p>If your system does not have ATLAS installed, or there are no pre-built binaries available, you will need to install ATLAS from source. Even if your system has pre-built binaries available, they may not be the best binaries possible for your architecture so it is probably a better idea to compile from source. The easiest way to do this is to cd from "src" to "../tools" and to run ./install_atlas.sh. If this does not work, the detailed installation instructions can be found at: <a href="http://math-atlas.sourceforge.net/atlas_install/">http://math-atlas.sourceforge.net/atlas_install/</a>.</p>
<p>One useful note is that before installing ATLAS you should turn off CPU throttling using "cpufreq-selector -g performance" (cpufreq-selector may be in sbin), if it is enabled (see the ATLAS install page). You can first try running the "install_atlas.sh" script before doing this, to see whether it works&ndash; if CPU throttling is enabled, the ATLAS installation scripts will die with an error.</p>
<h1><a class="anchor" id="matrixwrap_mkl"></a>
Intel Math Kernel Library (MKL)</h1>
<p>Intel MKL also provides C-language interface to the BLAS and LAPACK routines, and can be used with Kaldi by using the -DHAVE_MKL compiler flag. The linker flags for MKL tend to be quite different depending on the OS, architecture, compiler, etc. used. We have tested Kaldi on 32-bit Windows and x86_64 (or EMT64) Linux. Flags for other platforms can be obtained from: <a href="http://software.intel.com/en-us/articles/intel-mkl-link-line-advisor/">http://software.intel.com/en-us/articles/intel-mkl-link-line-advisor/</a></p>
<h1><a class="anchor" id="matrixwrap_openblas"></a>
OpenBLAS</h1>
<p>Kaldi now supports linking against the OpenBLAS library, which is an implementation of BLAS and parts of LAPACK. OpenBLAS also automatically compiles Netlib's implementation of LAPACK, so that it can explort LAPACK in its entirety. OpenBLAS is a fork of the GotoBLAS project (an assembler-heavy implementation of BLAS) which is no longer being maintained. In order to use GotoBLAS you can cd from "src" to "../tools", type "make openblas", then cd to "../src" and give the correct option to the "configure" script to use OpenBLAS (look at the comments at the top of the configure script to find this option). Thanks to Sola Aina for suggesting this and helping us to get this to work.</p>
<h1><a class="anchor" id="matrixwrap_jama"></a>
Java Matrix Package (JAMA)</h1>
<p>JAMA is an implementation of linear-algebra routines for Java, written in collaboration between NIST and MathWorks and put into the public domain (see math.nist.gov/javanumerics/jama). We used some of this code to fill in a couple of holes in ATLAS&ndash; specifically, if we're compiling with -DHAVE_ATLAS, we don't have the CLAPACK routines for SVD and eigenvalue decomposition available, so we use code from JAMA that we translated into C++. See the <a class="el" href="classkaldi_1_1EigenvalueDecomposition.html">EigenvalueDecomposition</a> class, and the function MatrixBase::JamaSvd. The user of the matrix library should never have to interact with this code directly.</p>
<h1><a class="anchor" id="matrixwrap_linking_errors"></a>
Linking errors you might encounter</h1>
<p>To make sure the matrix library is compiling correctly, type "make" in the matrix/ directory and see if it succeeds. A lot of compilation issues will manifest themselves as linking errors. In this section we give a summary of some of the more common linking errors (at least, those that relate specifically to the matrix library).</p>
<p>Depending on the compilation option (-DHAVE_CLAPACK, -DHAVE_LAPACK or -DHAVE_MKL), the code will be expecting to link with different things. When debugging linking errors, bear in mind that the problem could be a mismatch between the compilation options and the libraries that you actually linked.</p>
<h2><a class="anchor" id="matrix_err_f2c"></a>
f2c or g2c errors</h2>
<p>The f2c library is often required if you link with CLAPACK, because it was created with f2c and that tool requires you to link with its own library. Not that with recent versions of gcc you have to link with -lg2c not -lf2c.</p>
<p>The symbols that will be missing if this is the problem, include:</p>
<p>s_cat, pow_dd, r_sign, pow_ri, pow_di, s_copy, s_cmp, d_sign</p>
<h2><a class="anchor" id="matrix_err_clapack"></a>
CLAPACK linking errors</h2>
<p>You will get these errors if you compiled with -DHAVE_CLAPACK but did not provide the CLAPACK library. The symbols you will be missing are:</p>
<p>sgetrf_, sgetri_, dgesvd_, ssptrf_, ssptri_, dsptrf_, dsptri_, stptri_, dtptri_</p>
<p>This will usually be called something like liblapack.a or if using a dynamic library, you would type -llapack. Be careful&ndash; this has the same name as the ATLAS-supplied library "lapack" (see section <a class="el" href="matrixwrap.html#matrix_err_clapack">CLAPACK linking errors</a>), but it supplies different symbols. The native CLAPACK version of liblapack has symbols like those above (e.g. sgesvd_, sgetrf_), but the ATLAS version has symbols like clapack_sgetrf and also ones like ATL_sgetrf.</p>
<h2><a class="anchor" id="matrix_err_blas"></a>
BLAS linking errors</h2>
<p>You will get these errors if you failed to link against an implementation of BLAS. These errors can also occur if libraries are linked in the wrong order. CLAPACK requires BLAS, so you have to link BLAS after CLAPACK.</p>
<p>The symbols you will see if you failed to link with BLAS include:</p>
<p>cblas_sger, cblas_saxpy, cblas_dapy, cblas_ddot, cblas_sdot, cblas_sgemm, cblas_dgemm</p>
<p>To fix these, link with a static library like libcblas.a, or do -lcblas (assuming such a library is on your LD_LIBRARY_PATH). This library may come from ATLAS (which is preferable), or from Netlib (the "reference BLAS"). To the best of my current knowledge they have the same interface.</p>
<h2><a class="anchor" id="matrix_err_cblaswrap"></a>
cblaswrap linking errors</h2>
<p>CLAPACK seems to rely on symbols like f2c_sgemm that are some kind of wrapping of symbols like cblas_sgemm and so on. I'm not sure exactly what is being wrapped, and why. Anyway, the effect is that you may need to include a library named libcblaswr.a or dynamically using -lcblaswr, if you are using Netlib's CLAPACK. The cblaswrap library should be invoked before the cblas one. If you are missing cblaswrap, you will see errors about symbols like:</p>
<p>f2c_sgemm, f2c_strsm, f2c_sswap, f2c_scopy, f2c_sspmv, f2c_sdot, f2c_sgemv</p>
<p>and so on (there are a lot of these symbols).</p>
<h2><a class="anchor" id="matrix_err_atl_blas"></a>
Missing the ATLAS implementation of BLAS</h2>
<p>If you linked with an ATLAS implementation of BLAS but only did -lcblas (or compiled with libcblas.a), but did not do -latlas (or compile with libatlas.a), you will have a problem because ATLAS's BLAS routines like cblas_sger internally call things that are in libatlas. If you have this problem you will have undefined references like:</p>
<p>ATL_dgemm, ATL_dsyrk, ATL_dsymm, ATL_daxpy, ATL_ddot, ATL_saxpy, ATL_dgemv, ATL_sgemv</p>
<h2><a class="anchor" id="matrix_err_atl_clapack"></a>
Missing the ATLAS implementation of (parts of) CLAPACK</h2>
<p>These errors can only occur if you compiled wiht the -DHAVE_ATLAS option. Atlas's name for the CLAPACK routines are different from clapack's own (they have clapack_ prepended to indicate the origin, which can be quite confusing).</p>
<p>If you have undefined references to the following symbols:</p>
<p>clapack_sgetrf, clapack_sgetri, clapack_dgetrf, clapack_dgetri</p>
<p>then it means you failed to link with an ATLAS library containing these symbols. This may be variously called liblapack.a, libclapack.a or liblapack_atlas.a, but you can tell that it is the right one if it defines a symbol called ATL_cgetrf (type "nm &lt;library-name&gt; | grep ATL_cgetrf" to see). You may be able to link dynamically with this library using -llapack or some similar option. Watch out, because a library called liblapack.a or liblapack.so could be CLAPACK or it could be ATLAS's version of CLAPACK, and as noted in section <a class="el" href="matrixwrap.html#matrix_err_f2c">f2c or g2c errors</a>, they supply different symbols. The only way to find out is to look inside it using "nm" or "strings". </p>
</div></div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><a class="el" href="index.html">Kaldi</a></li>
    <li class="footer">Generated on Thu Apr 28 2016 15:42:38 for Kaldi by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.6 </li>
  </ul>
</div>
</body>
</html>
